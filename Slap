print("Script Final - Full Persist v3") 

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local ToolName = "Diamond"
local SLAP_POWER = 30000
local TROLL_FULL_DELAY = 0.1
local SPAWN_HITBOX_SIZE = 999

local TrollFullEnabled = false
local Spamming = false
local TrollSpamming = false
local TrollPlayerSpamming = false
local TrollButtonActive = false

local hitboxSize = 15
local trollRadius = 3
local trollPlayerName = ""
local TrollCenter = Vector3.new(320.10, 57.87, 283.55)
local BUTTON_CENTER = Vector3.new(320.53, 57.54, 283.36)
local BUTTON_RADIUS = 6.00

local spawnVisuals = {}
local hitboxIndicator = nil
local trollHitboxIndicator = nil
local trollPlayerHitboxIndicator = nil

local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

if not success or not Rayfield then return end

local Window = Rayfield:CreateWindow({
    Name = "Universal Troll - Fix New Players",
    LoadingTitle = "Loading...",
    LoadingSubtitle = "By WarningBot_Dead",
    ConfigurationSaving = {Enabled = true, FolderName = nil, FileName = "TrollConfig"},
    ToggleUIKeybind = "T",
})

local Tab = Window:CreateTab("Main")

local function hasDiamond()
    local bp = LocalPlayer:FindFirstChild("Backpack")
    local char = LocalPlayer.Character
    return (bp and bp:FindFirstChild(ToolName)) or (char and char:FindFirstChild(ToolName))
end

local function equipTool()
    local bp = LocalPlayer:FindFirstChild("Backpack")
    if bp and bp:FindFirstChild(ToolName) then
        bp[ToolName].Parent = LocalPlayer.Character
    end
end

local function slap(targetChar)
    if not targetChar then return end
    local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild(ToolName)
    local remote = tool and tool:FindFirstChild("Event")
    local root = targetChar:FindFirstChild("HumanoidRootPart")
    
    if remote and root then
        pcall(function()
            remote:FireServer("slash", targetChar, root.Position, Vector3.new(0, SLAP_POWER, 0))
        end)
    end
end

local function updateSpawnVisuals()
    for _, v in pairs(spawnVisuals) do v:Destroy() end
    spawnVisuals = {}
    if TrollFullEnabled then
        for _, obj in pairs(Workspace:GetDescendants()) do
            if obj:IsA("SpawnLocation") then
                local p = Instance.new("Part")
                p.Size = Vector3.new(SPAWN_HITBOX_SIZE, SPAWN_HITBOX_SIZE, SPAWN_HITBOX_SIZE)
                p.Position = obj.Position
                p.Anchored, p.CanCollide, p.Transparency = true, false, 0.8
                p.Color, p.Material = Color3.fromRGB(255, 0, 0), Enum.Material.ForceField
                p.Parent = Workspace
                table.insert(spawnVisuals, p)
            end
        end
    end
end

-- Troll FULL Loop (Constant Scan)
task.spawn(function()
    while true do
        if TrollFullEnabled then
            if hasDiamond() then
                if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild(ToolName)) then
                    equipTool()
                end
                -- Gets EVERYONE currently in the server every loop
                for _, pl in pairs(Players:GetPlayers()) do
                    if pl ~= LocalPlayer and pl.Character then
                        slap(pl.Character)
                    end
                end
            end
        end
        task.wait(TROLL_FULL_DELAY)
    end
end)

-- Other Hitboxes Loop
task.spawn(function()
    while true do
        if not TrollFullEnabled then
            if Spamming then
                local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if myRoot then
                    if hitboxIndicator then hitboxIndicator.Position = myRoot.Position end
                    for _, pl in pairs(Players:GetPlayers()) do
                        if pl ~= LocalPlayer and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
                            if (pl.Character.HumanoidRootPart.Position - myRoot.Position).Magnitude <= hitboxSize then
                                slap(pl.Character)
                            end
                        end
                    end
                end
            elseif TrollSpamming then
                for _, pl in pairs(Players:GetPlayers()) do
                    if pl ~= LocalPlayer and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
                        if (pl.Character.HumanoidRootPart.Position - TrollCenter).Magnitude <= trollRadius then
                            slap(pl.Character)
                        end
                    end
                end
            elseif TrollPlayerSpamming and trollPlayerName ~= "" then
                local target = Players:FindFirstChild(trollPlayerName)
                if target and target.Character then
                    if trollPlayerHitboxIndicator then trollPlayerHitboxIndicator.Position = target.Character.HumanoidRootPart.Position end
                    slap(target.Character)
                end
            end
        end
        task.wait(0.1)
    end
end)

Tab:CreateToggle({
    Name = "Troll FULL (Spawn + Server + New Players)",
    CurrentValue = false,
    Flag = "TrollFull",
    Callback = function(Value)
        TrollFullEnabled = Value
        updateSpawnVisuals()
        if not Value then for _, v in pairs(spawnVisuals) do v:Destroy() end spawnVisuals = {} end
    end,
})

Tab:CreateToggle({
    Name = "Activate Troll System (Self)",
    CurrentValue = false,
    Flag = "Spamming",
    Callback = function(Value)
        Spamming = Value
        if Value then
            hitboxIndicator = Instance.new("Part", Workspace)
            hitboxIndicator.Size = Vector3.new(hitboxSize, hitboxSize, hitboxSize)
            hitboxIndicator.Anchored, hitboxIndicator.CanCollide, hitboxIndicator.Transparency = true, false, 0.7
            hitboxIndicator.Color, hitboxIndicator.Material = Color3.fromRGB(150, 100, 255), Enum.Material.ForceField
        elseif hitboxIndicator then hitboxIndicator:Destroy() end
    end,
})

Tab:CreateInput({
    Name = "Aura Size",
    PlaceholderText = "15",
    Callback = function(Text) hitboxSize = tonumber(Text) or 15 end,
})

Tab:CreateToggle({
    Name = "Hitbox Troll (Fixed)",
    CurrentValue = false,
    Flag = "TrollSpamming",
    Callback = function(Value)
        TrollSpamming = Value
        if Value then
            trollHitboxIndicator = Instance.new("Part", Workspace)
            trollHitboxIndicator.Size = Vector3.new(trollRadius*2, trollRadius*2, trollRadius*2)
            trollHitboxIndicator.Position, trollHitboxIndicator.Anchored, trollHitboxIndicator.CanCollide = TrollCenter, true, false
            trollHitboxIndicator.Transparency, trollHitboxIndicator.Color = 0.7, Color3.fromRGB(255, 100, 100)
            trollHitboxIndicator.Material = Enum.Material.ForceField
        elseif trollHitboxIndicator then trollHitboxIndicator:Destroy() end
    end,
})

Tab:CreateInput({
    Name = "Target Name",
    PlaceholderText = "Username",
    Callback = function(Text) trollPlayerName = Text end,
})

Tab:CreateToggle({
    Name = "Focus Target",
    CurrentValue = false,
    Flag = "TrollPlayer",
    Callback = function(Value)
        TrollPlayerSpamming = Value
        if Value then
            trollPlayerHitboxIndicator = Instance.new("Part", Workspace)
            trollPlayerHitboxIndicator.Size = Vector3.new(10,10,10)
            trollPlayerHitboxIndicator.Anchored, trollPlayerHitboxIndicator.CanCollide, trollPlayerHitboxIndicator.Transparency = true, false, 0.7
            trollPlayerHitboxIndicator.Color = Color3.fromRGB(255,0,0)
        elseif trollPlayerHitboxIndicator then trollPlayerHitboxIndicator:Destroy() end
    end,
})

Tab:CreateToggle({
    Name = "Troll Button Auto",
    CurrentValue = false,
    Callback = function(Value)
        TrollButtonActive = Value
        task.spawn(function()
            while TrollButtonActive do
                local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local region = Region3.new(BUTTON_CENTER - Vector3.new(BUTTON_RADIUS, BUTTON_RADIUS, BUTTON_RADIUS), BUTTON_CENTER + Vector3.new(BUTTON_RADIUS, BUTTON_RADIUS, BUTTON_RADIUS))
                    for _, p in pairs(Workspace:FindPartsInRegion3(region, nil, 100)) do
                        firetouchinterest(hrp, p, 0)
                        firetouchinterest(hrp, p, 1)
                    end
                end
                task.wait(0.2)
            end
        end)
    end,
})

LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(1)
    if TrollFullEnabled or Spamming or TrollSpamming or TrollPlayerSpamming then
        if hasDiamond() then equipTool() end
    end
end)
